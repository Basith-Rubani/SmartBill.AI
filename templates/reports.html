{% extends "base.html" %}{% block title %} Reports | SmartBill.AI {% endblock %}
{% block content %}

<style>
  .reports-page {
    max-width: 1200px;
    margin: auto;
    padding: 24px;
  }

  .page-title {
    text-align: center;
    font-size: 2rem;
    font-weight: 700;
    margin: 30px 0 24px;
    color: #1f2937;
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.65);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  }

  /* ===================== AI Insights ===================== */
  .ai-insights-card {
    margin-bottom: 28px;
  }

  .ai-insights-card h2 {
    font-size: 1.3rem;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .ai-insights-list {
    list-style: none;
    padding: 0;
    margin-top: 12px;
  }

  .ai-insights-list li {
    background: rgba(255, 255, 255, 0.85);
    padding: 12px 16px;
    border-radius: 14px;
    margin-bottom: 10px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease;
    font-size: 0.95rem;
    line-height: 1.4;
    color: #111827;
  }

  .ai-insights-list li strong {
    min-width: 120px;
    display: inline-block;
    color: #2563eb;
  }

  .ai-insights-list li.loading {
    justify-content: center;
    font-style: italic;
    color: #6b7280;
    box-shadow: none;
    background: transparent;
  }

  /* ===================== KPI & Charts ===================== */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 36px;
  }

  .stat-card {
    text-align: center;
    min-height: 130px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .stat-card h3 {
    font-size: 0.85rem;
    color: #6b7280;
    margin: 0 0 6px;
  }

  .stat-card p {
    font-size: 1.8rem;
    font-weight: 800;
    color: #111827;
    margin: 0;
  }

  .chart-container {
    margin-bottom: 36px;
  }

  .chart-box {
    height: 320px;
    position: relative;
    padding-top: 30px;
  }

  .chart-box canvas {
    position: absolute;
    inset: 0;
  }

  .kpi-text {
    font-size: 1.05rem;
    font-weight: 600;
    line-height: 1.3;
    text-align: center;
    word-break: break-word;
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 1.6rem;
    }
  }
</style>

<div class="reports-page">
  <!-- AI Insights -->
  <div class="ai-insights-card glass-card">
    <h2>ü§ñ Smart Business Insights</h2>
    <ul id="aiInsightsList" class="ai-insights-list">
      <li class="loading">Analyzing business data‚Ä¶</li>
    </ul>
  </div>

  <!-- Dashboard Title -->
  <h1 class="page-title">üìä Business Insights Dashboard</h1>

  <!-- KPI Cards -->
  <div class="card-grid kpi-grid">
    <div class="card kpi-card">
      <div class="kpi-header">
        <span class="kpi-icon">üí∞</span>
        <h3>Total Revenue</h3>
      </div>
      <div class="kpi-value" id="totalRevenue">‚Çπ0</div>
    </div>

    <div class="card kpi-card">
      <div class="kpi-header">
        <span class="kpi-icon">üìÑ</span>
        <h3>Total Bills</h3>
      </div>
      <div class="kpi-value" id="totalBills">0</div>
    </div>

    <div class="card kpi-card">
      <div class="kpi-header">
        <span class="kpi-icon">üèÜ</span>
        <h3>Top Product</h3>
      </div>
      <div class="kpi-value kpi-text" id="topProduct">0</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="chart-container glass-card">
    <div class="chart-box"><canvas id="revenueChart"></canvas></div>
  </div>

  <div class="chart-container glass-card">
    <div class="chart-box"><canvas id="topProductsChart"></canvas></div>
  </div>

  <div class="chart-container glass-card">
    <div class="chart-box"><canvas id="monthRevenueChart"></canvas></div>
  </div>

  <div class="chart-container glass-card">
    <div class="chart-box"><canvas id="monthBillsChart"></canvas></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetch("/reports/data")
      .then((res) => res.json())
      .then((data) => {
        const insightsList = document.getElementById("aiInsightsList");
        insightsList.innerHTML = "";

        // -------- AI Insights --------
        if (data.ai_insights_gpt) {
          const map = {
            trend: "Trend",
            reason: "Reason",
            prediction: "Prediction",
            risk: "Risk",
            recommendation: "Recommendation",
          };
          Object.entries(map).forEach(([key, label]) => {
            if (data.ai_insights_gpt[key]) {
              const li = document.createElement("li");
              li.innerHTML = `<strong>${label}:</strong> ${data.ai_insights_gpt[key]}`;
              insightsList.appendChild(li);
            }
          });
        } else if (data.ai_insights_basic?.sentences) {
          data.ai_insights_basic.sentences.forEach((sentence) => {
            const li = document.createElement("li");
            li.textContent = sentence;
            insightsList.appendChild(li);
          });
        } else {
          const li = document.createElement("li");
          li.textContent = "No insights available yet.";
          insightsList.appendChild(li);
        }

        // -------- KPIs --------
        document.getElementById("totalRevenue").textContent =
          "‚Çπ" + Number(data.total_sales || 0).toFixed(2);
        document.getElementById("totalBills").textContent = Number(
          data.total_bills || 0,
        );
        if (data.top_product_names?.length) {
          document.getElementById("topProduct").textContent =
            `${data.top_product_names[0]} (${data.top_product_sales[0]})`;
        }

        // -------- Daily Revenue Chart --------
        new Chart(document.getElementById("revenueChart"), {
          type: "line",
          data: {
            labels: data.daily_labels.map((d) => d || "N/A"), // replace missing labels
            datasets: [
              {
                lable: "Daily Revenue",
                data: data.daily_revenue.map(Number),
                borderColor: "#2563eb",
                backgroundColor: "rgba(37,99,235,0.15)",
                fill: true,
                tension: 0.35,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "üìà Daily Revenue Trend",
                font: { size: 16, weight: "600" },
              },
            },
            scales: { y: { beginAtZero: true } },
          },
        });

        // -------- Top Products Chart --------
        new Chart(document.getElementById("topProductsChart"), {
          type: "bar",
          data: {
            labels: data.top_product_names.map((p) => p || "Unknown"), // replace missing names
            datasets: [
              {
                label: "Units Sold",
                data: data.top_product_sales.map(Number),
                backgroundColor: "#22c55e",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "üèÜ Top Selling Products",
                font: { size: 16, weight: "600" },
              },
            },
            scales: { y: { beginAtZero: true } },
          },
        });

        new Chart(document.getElementById("monthRevenueChart"), {
          type: "bar",
          data: {
            labels: data.months,
            datasets: [
              {
                label: "Current Month",
                data: data.current_month_revenue,
                backgroundColor: "#2563eb",
              },
              {
                label: "Previous Month",
                data: data.previous_month_revenue,
                backgroundColor: "#10b981",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "üìä Month vs Month Revenue",
                font: { size: 16, weight: "600" },
              },
            },
            scales: { y: { beginAtZero: true } },
          },
        });

        new Chart(document.getElementById("monthBillsChart"), {
          type: "bar",
          data: {
            labels: data.months,
            datasets: [
              {
                label: "Current Month",
                data: data.current_month_bills,
                backgroundColor: "#f97316",
              },
              {
                label: "Previous Month",
                data: data.previous_month_bills,
                backgroundColor: "#3b82f6",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "üßæ Month vs Month Bills",
                font: { size: 16, weight: "600" },
              },
            },
            scales: { y: { beginAtZero: true } },
          },
        });
      })
      .catch((err) => console.error("Reports error:", err));
  });
</script>

{% endblock %}
